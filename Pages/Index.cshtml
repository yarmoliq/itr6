@page
@inject IJsonHelper Json;
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<link rel="stylesheet" type="text/css" href="~/css/note/notes.css">
<script src="~/js/signalr/dist/browser/signalr.js"></script>
<script src="~/js/note/notes.js"></script>

<script>

    let connection = new signalR.HubConnectionBuilder().withUrl("/noteshub").build();

    connection.start().catch(err=>{
        alert("couldnt connect");
    }).then(() => {
    const notes = @Json.Serialize(Model.GetNotes());
        notes.forEach( (note) => {
            createNoteHtml(note);
        });
    });

</script>

<script>

    let mousePosition;
    let offset = [0, 0];
    let div;
    let isDown = false;
    let movingNote;

    const createNoteHtml = function(note){
        let newNote = document.createElement("textarea");
        newNote.setAttribute("class", "floating-note");
        newNote.value = note["contents"];
        newNote.disabled = true;
        newNote.style.left = Math.random() * 0.8 * window.screen.width  + 'px';
        newNote.style.top  = Math.random() * 0.8 * window.screen.height + 'px';

        createNote(note["id"], note["contents"], (noteDiv) => {
            //newNote.appendChild(noteDiv);
            newNote.setAttribute("id", "floating-note-" + noteDiv.getAttribute("id"));
        });

        //newNote.setAttribute("id", note["id"]);

        document.body.appendChild(newNote);
    }

    document.addEventListener('dblclick', function(event) {
        if (event.target.getAttribute("class") == "floating-note") {
            const noteId = event.target.id.split("-")[2];
            showNote(noteId);
        }
    });

    document.addEventListener('mousedown',
        function (event) {
            if(event.target.getAttribute("class") == "floating-note"){
                movingNote = event.target;
                isDown = true;
                offset = [
                    movingNote.offsetLeft - event.clientX,
                    movingNote.offsetTop - event.clientY
                ];
            }
        }
    );

    document.addEventListener('mouseup', function () {
        isDown = false;
    });

    document.addEventListener('mousemove', function (event) {
        //if(event.target.getAttribute("class") == "floating-note"){
            if (isDown) {
                event.preventDefault();
                mousePosition = {
                    x: event.clientX,
                    y: event.clientY
                };
                movingNote.style.left = (mousePosition.x + offset[0]) + 'px';
                movingNote.style.top = (mousePosition.y + offset[1]) + 'px';
            }
        //}
    });

</script>